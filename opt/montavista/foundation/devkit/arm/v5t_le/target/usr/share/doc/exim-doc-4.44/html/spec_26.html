<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Exim 4.40 Specification chapter 26</title>
</head>
<body bgcolor="#F8F8F8" text="#00005A" link="#FF6600" alink="#FF9933" vlink="#990000">
<font size=2>
<a href="spec_25.html">Previous</a>&nbsp;&nbsp;
<a href="spec_27.html">Next</a>&nbsp;&nbsp;
<a href="spec_toc.html">Contents</a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Exim 4.40 Specification)
</font><hr>
<a name="IX1920"></a>
<a name="IX1921"></a>
<a name="IX1922"></a>
<a name="IX1923"></a>
<h1>
<a name="CHAP26" href="spec_toc.html#TOC197">
26. The appendfile transport
</a></h1>
<p>
The <b>appendfile</b> transport delivers a message by appending it to an existing
file, or by creating an entirely new file in a specified directory. Single
files to which messages are appended can be in the traditional Unix mailbox
format, or optionally in the MBX format supported by the Pine MUA and
University of Washington IMAP daemon, <em>inter alia</em>. When each message is
being delivered as a separate file, &#147;maildir&#148; format can optionally be used to
give added protection against failures that happen part-way through the
delivery. A third form of separate-file delivery known as &#147;mailstore&#148; is also
supported. For all file formats, Exim attempts to create as many levels of
directory as necessary, provided that <tt>create&#095;directory</tt> is set.
</p>
<p>
The code for the optional formats is not included in the Exim binary by
default. It is necessary to set <font size=-1>SUPPORT&#095;MBX</font>, <font size=-1>SUPPORT&#095;MAILDIR</font> and/or
<font size=-1>SUPPORT&#095;MAILSTORE</font> in <i>Local/Makefile</i> to have the appropriate code
included.
<a name="IX1924"></a>
</p>
<p>
Exim recognises system quota errors, and generates an appropriate message. Exim
also supports its own quota control within the transport, for use when the
system facility is unavailable or cannot be used for some reason.
</p>
<p>
If there is an error while appending to a file (for example, quota exceeded or
partition filled), Exim attempts to reset the file's length and last
modification time back to what they were before. If there is an error while
creating an entirely new file, the new file is removed.
</p>
<p>
Before appending to a file, a number of security checks are made, and the
file is locked. A detailed description is given below, after the list of
private options.
</p>
<p>
<b>appendfile</b> is most commonly used for local deliveries to users' mailboxes.
However, it can also be used as a pseudo-remote transport for putting messages
into files for remote delivery by some means other than Exim. &#147;Batch SMTP&#148;
format is often used in this case (see the <tt>use&#095;bsmtp</tt> option). 
</p>
<h2>
<a name="SECT26.1" href="spec_toc.html#TOC198">
26.1. The file and directory options
</a></h2>
<p>
The <tt>file</tt> option specifies a single file, to which the message is appended; 
the <tt>directory</tt> option specifies a directory, in which a new file containing 
the message is created. Only one of these two options can be set, and for
normal deliveries to mailboxes, one of them <i>must</i> be set.
</p>
<p>
However, <b>appendfile</b> is also used for delivering messages to files or
directories whose names (or parts of names) are obtained from alias,
forwarding, or filtering operations (for example, a <tt>save</tt> command in a user's
Exim filter). When such a transport is running, <tt>$local&#095;part</tt> contains the
local part that was aliased or forwarded, and <tt>$address&#095;file</tt> contains the
name (or partial name) of the file or directory generated by the redirection
operation. There are two cases:
</p>
<ul>
<li><p>
If neither <tt>file</tt> nor <tt>directory</tt> is set, the redirection operation
must specify an absolute path (one that begins with <tt>/</tt>). This is the most 
common case when users with local accounts use filtering to sort mail into 
different folders. See for example, the <b>address&#095;file</b> transport in the
default configuration. If the path ends with a slash, it is assumed to be the
name of a directory. A delivery to a directory can also be forced by setting 
<tt>maildir&#095;format</tt> or <tt>mailstore&#095;format</tt>.
</p>
</li>
<li><p>
If <tt>file</tt> or <tt>directory</tt> is set for a delivery from a redirection, it is used
to determine the file or directory name for the delivery. Normally, the
contents of <tt>$address&#095;file</tt> are used in some way in the string expansion. 
</p>
</li>
</ul>
<a name="IX1925"></a>
<a name="IX1926"></a>
<p>
As an example of the second case, consider an environment where users do not
have home directories. They may be permitted to use Exim filter commands of the
form:
<pre>
&nbsp;&nbsp;save folder23
</pre>
</p>
<p>
or Sieve filter commands of the form:
<pre>
&nbsp;&nbsp;require "fileinto"; 
&nbsp;&nbsp;fileinto "folder23";
</pre>
</p>
<p>
In this situation, the expansion of <tt>file</tt> or <tt>directory</tt> in the transport must
transform the relative path into an appropriate absolute file name. In the case 
of Sieve filters, the name <i>inbox</i> must be handled. It is the name that is 
used as a result of a &#147;keep&#148; action in the filter. This example shows one way 
of handling this requirement:
<pre>
&nbsp;&nbsp;file = ${if eq{$address_file}{inbox} \
&nbsp;&nbsp;            {/var/mail/$local_part} \
&nbsp;&nbsp;            {${if eq{${substr_0_1:$address_file}}{/} \
&nbsp;&nbsp;                  {$address_file} \
&nbsp;&nbsp;                  {$home/mail/$address_file} \
&nbsp;&nbsp;            }} \
&nbsp;&nbsp;       }
</pre>
</p>
<p>
With this setting of <tt>file</tt>, <i>inbox</i> refers to the standard mailbox location, 
absolute paths are used without change, and other folders are in the <i>mail</i>
directory within the home directory.
</p>
<p>
<b>Note 1</b>: While processing an Exim filter, a relative path such as
<i>folder23</i> is turned into an absolute path if a home directory is known to
the router. In particular, this is the case if <tt>check&#095;local&#095;user</tt> is set. If
you want to prevent this happening at routing time, you can set
<tt>router&#095;home&#095;directory</tt> empty. This forces the router to pass the relative
path to the transport.
</p>
<p>
<b>Note 2</b>: An absolute path in <tt>$address&#095;file</tt> is not treated specially;
the <tt>file</tt> or <tt>directory</tt> option is still used if it is set.
</p>
<a name="IX1927"></a>
<h2>
<a name="SECT26.2" href="spec_toc.html#TOC199">
26.2. Private options for appendfile
</a></h2>
<hr><a name="IX1928"></a>
<a name="IX1929"></a>
<a name="IX1930"></a>
<a name="IX1931"></a>
<h3>allow_fifo</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
Setting this option permits delivery to named pipes (FIFOs) as well as to
regular files. If no process is reading the named pipe at delivery time, the
delivery is deferred.
<hr></p>
<a name="IX1932"></a>
<a name="IX1933"></a>
<a name="IX1934"></a>
<h3>allow_symlink</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
By default, <b>appendfile</b> will not deliver if the path name for the file is
that of a symbolic link. Setting this option relaxes that constraint, but there
are security issues involved in the use of symbolic links. Be sure you know
what you are doing if you set this. Details of exactly what this option affects
are included in the discussion which follows this list of options.
<hr></p>
<a name="IX1935"></a>
<h3>batch_id</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
See the description of local delivery batching in chapter <a href="spec_25.html">25</a>.
However, batching is automatically disabled for <b>appendfile</b> deliveries that 
happen as a result of forwarding or aliasing or other redirection directly to a 
file.
<hr></p>
<a name="IX1936"></a>
<h3>batch_max</h3>
<i>Type:</i>&nbsp; integer<br><i>Default:</i>&nbsp; 1<br>
<p>
See the description of local delivery batching in chapter <a href="spec_25.html">25</a>.
<hr></p>
<a name="IX1937"></a>
<h3>check_group</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
When this option is set, the group owner of the file defined by the <tt>file</tt>
option is checked to see that it is the same as the group under which the
delivery process is running. The default setting is false because the default
file mode is 0600, which means that the group is irrelevant.
<hr></p>
<a name="IX1938"></a>
<h3>check_owner</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; true<br>
<p>
When this option is set, the owner of the file defined by the <tt>file</tt> option is
checked to ensure that it is the same as the user under which the delivery
process is running.
<hr></p>
<a name="IX1939"></a>
<a name="IX1940"></a>
<h3>check_string</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; see below<br>
<p>
As <b>appendfile</b> writes the message, the start of each line is tested for
matching <tt>check&#095;string</tt>, and if it does, the initial matching characters are
replaced by the contents of <tt>escape&#095;string</tt>. The value of <tt>check&#095;string</tt> is a
literal string, not a regular expression, and the case of any letters it
contains is significant.
</p>
<p>
If <tt>use&#095;bsmtp</tt> is set the values of <tt>check&#095;string</tt> and <tt>escape&#095;string</tt> are
forced to &#147;.&#148; and &#147;..&#148; respectively, and any settings in the configuration are
ignored. Otherwise, they default to &#147;From &#148; and &#147;&#062;From &#148; when the <tt>file</tt> option
is set, and unset when 
any of the <tt>directory</tt>, <tt>maildir</tt>, or <tt>mailstore</tt> options are set.
</p>
<p>
<a name="IX1941"></a>
<a name="IX1942"></a>
The default settings, along with <tt>message&#095;prefix</tt> and <tt>message&#095;suffix</tt>, are
suitable for traditional &#147;BSD&#148; mailboxes, where a line beginning with &#147;From &#148;
indicates the start of a new message. All four options need changing if another
format is used. For example, to deliver to mailboxes in MMDF format:
<pre>
&nbsp;&nbsp;check_string = "\1\1\1\1\n"
&nbsp;&nbsp;escape_string = "\1\1\1\1 \n"
&nbsp;&nbsp;message_prefix = "\1\1\1\1\n"
&nbsp;&nbsp;message_suffix = "\1\1\1\1\n"
</pre>
<a name="IX1943"></a>
<hr></p>
<a name="IX1944"></a>
<h3>create_directory</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; true<br>
<p>
When this option is true, Exim attempts to create any missing superior
directories for the file that it is about to write. A created directory's mode
is given by the <tt>directory&#095;mode</tt> option.
<hr></p>
<a name="IX1945"></a>
<h3>create_file</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; anywhere<br>
<p>
This option constrains the location of files and directories that are created
by this transport. It applies to files defined by the <tt>file</tt> option and
directories defined by the <tt>directory</tt> option. In the case of maildir delivery,
it applies to the top level directory, not the maildir directories beneath.
</p>
<p>
The option must be set to one of the words &#147;anywhere&#148;, &#147;inhome&#148;, or
&#147;belowhome&#148;. In the second and third cases, a home directory must have been set
for the transport. This option is not useful when an explicit file name is
given for normal mailbox deliveries. It is intended for the case when file
names are generated from users' <i>.forward</i> files. These are usually handled
by an <b>appendfile</b> transport called <tt>address&#095;file</tt>. See also
<tt>file&#095;must&#095;exist</tt>.
<hr></p>
<a name="IX1946"></a>
<h3>directory</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option is mutually exclusive with the <tt>file</tt> option, but one of <tt>file</tt> or
<tt>directory</tt> must be set, unless the delivery is the direct result of a
redirection (see section <a href="spec_26.html#SECT26.1">26.1</a>).
</p>
<p>
When <tt>directory</tt> is set, the string is expanded, and the message is delivered
into a new file or files in or below the given directory, instead of being
appended to a single mailbox file. A number of different formats are provided
(see <tt>maildir&#095;format</tt> and <tt>mailstore&#095;format</tt>), and see section <a href="spec_26.html#SECT26.4">26.4</a>
for further details of this form of delivery.
<hr></p>
<a name="IX1947"></a>
<a name="IX1948"></a>
<h3>directory_file</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; <tt>q&#036;&#123;base62:&#036;tod&#095;epoch&#125;-&#036;inode</tt><br>
<p>
When <tt>directory</tt> is set, but neither <tt>maildir&#095;format</tt> nor <tt>mailstore&#095;format</tt>
is set, <b>appendfile</b> delivers each message into a file whose name is obtained
by expanding this string. The default value generates a unique name from the
current time, in base 62 form, and the inode of the file. The variable
<tt>$inode</tt> is available only when expanding this option.
<hr></p>
<a name="IX1949"></a>
<h3>directory_mode</h3>
<i>Type:</i>&nbsp; octal integer<br><i>Default:</i>&nbsp; 0700<br>
<p>
If <b>appendfile</b> creates any directories as a result of the <tt>create&#095;directory</tt>
option, their mode is specified by this option.
<hr></p>
<a name="IX1950"></a>
<h3>escape_string</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; see description<br>
<p>
See <tt>check&#095;string</tt> above.
<hr></p>
<a name="IX1951"></a>
<h3>file</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
<a name="IX1952"></a>
<a name="IX1953"></a>
<a name="IX1954"></a>
This option is mutually exclusive with the <tt>directory</tt> option, but one of
<tt>file</tt> or <tt>directory</tt> must be set, unless the delivery is the direct result of
a redirection (see section <a href="spec_26.html#SECT26.1">26.1</a>). The <tt>file</tt> option specifies a
single file, to which the message is appended. One or more of
<tt>use&#095;fcntl&#095;lock</tt>, <tt>use&#095;flock&#095;lock</tt>, or <tt>use&#095;lockfile</tt> must be set with
<tt>file</tt>.
If you are using more than one host to deliver over NFS into the same
mailboxes, you should always use lock files.
</p>
<p>
The string value is expanded for each delivery, and must yield an absolute
path. The most common settings of this option are variations on one of these
examples:
<pre>
&nbsp;&nbsp;file = /var/spool/mail/$local_part
&nbsp;&nbsp;file = /home/$local_part/inbox
&nbsp;&nbsp;file = $home/inbox
</pre>
<a name="IX1955"></a>
</p>
<p>
In the first example, all deliveries are done into the same directory. If Exim
is configured to use lock files (see <tt>use&#095;lockfile</tt> below) it must be able to
create a file in the directory, so the &#147;sticky&#148; bit must be turned on for
deliveries to be possible, or alternatively the <tt>group</tt> option can be used to
run the delivery under a group id which has write access to the directory.
<hr></p>
<a name="IX1956"></a>
<a name="IX1957"></a>
<h3>file_format</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; unset<br>
<p>
This option requests the transport to check the format of an existing file
before adding to it. The check consists of matching a specific string at the
start of the file. The value of the option consists of an even number of
colon-separated strings. The first of each pair is the test string, and the
second is the name of a transport. If the transport associated with a matched
string is not the current transport, control is passed over to the other
transport. For example, suppose the standard <b>local&#095;delivery</b> transport has
this added to it:
<pre>
&nbsp;&nbsp;file_format = "From       : local_delivery :\
&nbsp;&nbsp;               \1\1\1\1\n : local_mmdf_delivery"
</pre>
</p>
<p>
Mailboxes that begin with &#147;From&#148; are still handled by this transport, but if a
mailbox begins with four binary ones followed by a newline, control is passed
to a transport called <tt>local_mmdf_delivery</tt>, which presumably is configured
to do the delivery in MMDF format. If a mailbox does not exist or is empty, it
is assumed to match the current transport. If the start of a mailbox doesn't
match any string, or if the transport named for a given string is not defined,
delivery is deferred.
<hr></p>
<a name="IX1958"></a>
<h3>file_must_exist</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
If this option is true, the file specified by the <tt>file</tt> option must exist, and
an error occurs if it does not. Otherwise, it is created if it does not exist.
<hr></p>
<a name="IX1959"></a>
<a name="IX1960"></a>
<a name="IX1961"></a>
<a name="IX1962"></a>
<h3>lock_fcntl_timeout</h3>
<i>Type:</i>&nbsp; time<br><i>Default:</i>&nbsp; 0s<br>
<p>
By default, the <b>appendfile</b> transport uses non-blocking calls to <i>fcntl()</i>
when locking an open mailbox file. If the call fails, the delivery process
sleeps for <tt>lock&#095;interval</tt> and tries again, up to <tt>lock&#095;retries</tt> times.
Non-blocking calls are used so that the file is not kept open during the wait
for the lock; the reason for this is to make it as safe as possible for
deliveries over NFS in the case when processes might be accessing an NFS
mailbox without using a lock file. This should not be done, but
misunderstandings and hence misconfigurations are not unknown.
</p>
<p>
On a busy system, however, the performance of a non-blocking lock approach is
not as good as using a blocking lock with a timeout. In this case, the waiting
is done inside the system call, and Exim's delivery process acquires the lock
and can proceed as soon as the previous lock holder releases it.
</p>
<p>
If <tt>lock&#095;fcntl&#095;timeout</tt> is set to a non-zero time, blocking locks, with that
timeout, are used. There may still be some retrying: the maximum number of
retries is
<pre>
&nbsp;&nbsp;(lock_retries * lock_interval) / lock_fcntl_timeout
</pre>
</p>
<p>
rounded up to the next whole number. In other words, the total time during
which <b>appendfile</b> is trying to get a lock is roughly the same, unless
<tt>lock&#095;fcntl&#095;timeout</tt> is set very large.
</p>
<p>
You should consider setting this option if you are getting a lot of delayed
local deliveries because of errors of the form
<pre>
&nbsp;&nbsp;failed to lock mailbox /some/file (fcntl)
</pre>
<hr></p>
<a name="IX1963"></a>
<h3>lock_flock_timeout</h3>
<i>Type:</i>&nbsp; time<br><i>Default:</i>&nbsp; 0s<br>
<p>
This timeout applies to file locking when using <i>flock()</i> (see <tt>use&#095;flock</tt>);
the timeout operates in a similar manner to <tt>lock&#095;fcntl&#095;timeout</tt>.
<hr></p>
<a name="IX1964"></a>
<h3>lock_interval</h3>
<i>Type:</i>&nbsp; time<br><i>Default:</i>&nbsp; 3s<br>
<p>
This specifies the time to wait between attempts to lock the file. See below
for details of locking.
<hr></p>
<a name="IX1965"></a>
<h3>lock_retries</h3>
<i>Type:</i>&nbsp; integer<br><i>Default:</i>&nbsp; 10<br>
<p>
This specifies the maximum number of attempts to lock the file. A value of zero
is treated as 1. See below for details of locking.
<hr></p>
<a name="IX1966"></a>
<h3>lockfile_mode</h3>
<i>Type:</i>&nbsp; octal integer<br><i>Default:</i>&nbsp; 0600<br>
<p>
This specifies the mode of the created lock file, when a lock file is being
used (see <tt>use&#095;lockfile</tt>).
<hr></p>
<a name="IX1967"></a>
<a name="IX1968"></a>
<h3>lockfile_timeout</h3>
<i>Type:</i>&nbsp; time<br><i>Default:</i>&nbsp; 30m<br>
<p>
When a lock file is being used (see <tt>use&#095;lockfile</tt>), if a lock file already
exists and is older than this value, it is assumed to have been left behind by
accident, and Exim attempts to remove it.
<hr></p>
<a name="IX1969"></a>
<a name="IX1970"></a>
<h3>maildir_format</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
If this option is set with the <tt>directory</tt> option, the delivery is into a new
file, in the &#147;maildir&#148; format that is used by other mail software. When the
transport is activated directly from a <b>redirect</b> router (for example, the
<b>address&#095;file</b> transport in the default configuration), setting
<tt>maildir&#095;format</tt> causes the path received from the router to be treated as a
directory, whether or not it ends with <tt>/</tt>. This option is available only if
<font size=-1>SUPPORT&#095;MAILDIR</font> is present in <i>Local/Makefile</i>. See section
<a href="spec_26.html#SECT26.5">26.5</a> below for further details.
<font color=green><hr></p>
<a name="IX1971"></a>
<a name="IX1972"></a>
<a name="IX1973"></a>
<h3>maildir_quota_directory_regex</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; See below<br>
<p>
This option is relevant only when <tt>maildir&#095;use&#095;size&#095;file</tt> is set. It defines
a regular expression for specifying directories that should be included in the
quota calculation. The default value is
<pre>
&nbsp;&nbsp;maildir_quota_directory_regex = ^(?:cur|new|\..*)$
</pre>
</p>
<p>
which includes the <i>cur</i> and <i>new</i> directories, and any maildir++ folders
(directories whose names begin with a dot). If you want to exclude the 
<i>Trash</i>
folder from the count (as some sites do), you need to change this setting to
<pre>
&nbsp;&nbsp;maildir_quota_directory_regex = ^(?:cur|new|\.(?!Trash).*)$
</pre>
</p>
<p>
This uses a negative lookahead in the regular expression to exclude the
directory whose name is <i>.Trash</i>.
</font>
<hr></p>
<a name="IX1974"></a>
<h3>maildir_retries</h3>
<i>Type:</i>&nbsp; integer<br><i>Default:</i>&nbsp; 10<br>
<p>
This option specifies the number of times to retry when writing a file in
&#147;maildir&#148; format. See section <a href="spec_26.html#SECT26.5">26.5</a> below.
<hr></p>
<a name="IX1975"></a>
<h3>maildir_tag</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option applies only to deliveries in maildir format, and is described in
section <a href="spec_26.html#SECT26.5">26.5</a> below.
<hr></p>
<a name="IX1976"></a>
<a name="IX1977"></a>
<h3>maildir_use_size_file</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
Setting this option true enables support for <i>maildirsize</i> files. Exim
creates a <i>maildirsize</i> file in a maildir if one does not exist, taking the
quota from the <tt>quota</tt> option of the transport. If <tt>quota</tt> is unset, the value
is zero. See section <a href="spec_26.html#SECT26.5">26.5</a> below for further details.
<hr></p>
<a name="IX1978"></a>
<a name="IX1979"></a>
<h3>mailstore_format</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
If this option is set with the <tt>directory</tt> option, the delivery is into two new
files in  &#147;mailstore&#148; format. The option is available only if
<font size=-1>SUPPORT&#095;MAILSTORE</font> is present in <i>Local/Makefile</i>. See section
<a href="spec_26.html#SECT26.4">26.4</a> below for further details.
<hr></p>
<a name="IX1980"></a>
<h3>mailstore_prefix</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option applies only to deliveries in mailstore format, and is described in
section <a href="spec_26.html#SECT26.4">26.4</a> below.
<hr></p>
<a name="IX1981"></a>
<h3>mailstore_suffix</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option applies only to deliveries in mailstore format, and is described in
section <a href="spec_26.html#SECT26.4">26.4</a> below.
<hr></p>
<a name="IX1982"></a>
<a name="IX1983"></a>
<a name="IX1984"></a>
<a name="IX1985"></a>
<a name="IX1986"></a>
<h3>mbx_format</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
This option is available only if Exim has been compiled with <font size=-1>SUPPORT&#095;MBX</font>
set in <i>Local/Makefile</i>. If <tt>mbx&#095;format</tt> is set with the <tt>file</tt> option,
the message is appended to the mailbox file in MBX format instead of
traditional Unix format. This format is supported by Pine4 and its associated
IMAP and POP daemons, by means of the <i>c-client</i> library that they all use.
</p>
<p>
<b>Note</b>: The <tt>message&#095;prefix</tt> and <tt>message&#095;suffix</tt> options are not
automatically changed by the use of <tt>mbx&#095;format</tt>. They should normally be set
empty when using MBX format, so this option almost always appears in this 
combination:
<pre>
&nbsp;&nbsp;mbx_format = true
&nbsp;&nbsp;message_prefix =
&nbsp;&nbsp;message_suffix =
</pre>
</p>
<p>
If none of the locking options are mentioned in the configuration,
<tt>use&#095;mbx&#095;lock</tt> is assumed and the other locking options default to false. It
is possible to specify the other kinds of locking with <tt>mbx&#095;format</tt>, but
<tt>use&#095;fcntl&#095;lock</tt> and <tt>use&#095;mbx&#095;lock</tt> are mutually exclusive. MBX locking
interworks with <i>c-client</i>, providing for shared access to the mailbox. It
should not be used if any program that does not use this form of locking is
going to access the mailbox, nor should it be used if the mailbox file is NFS
mounted, because it works only when the mailbox is accessed from a single host.
</p>
<p>
If you set <tt>use&#095;fcntl&#095;lock</tt> with an MBX-format mailbox, you cannot use
the standard version of <i>c-client</i>, because as long as it has a mailbox open
(this means for the whole of a Pine or IMAP session), Exim will not be able to
append messages to it.
<hr></p>
<a name="IX1987"></a>
<a name="IX1988"></a>
<h3>message_prefix</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; see below<br>
<p>
The string specified here is expanded and output at the start of every message.
The default is unset unless <tt>file</tt> is specified and <tt>use&#095;bsmtp</tt> is not set, in
which case it is:
<pre>
&nbsp;&nbsp;message_prefix = "From ${if def:return_path{$return_path}\
&nbsp;&nbsp;  {MAILER-DAEMON}} $tod_bsdinbox\n"
</pre>
<hr></p>
<a name="IX1989"></a>
<h3>message_suffix</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; see below<br>
<p>
The string specified here is expanded and output at the end of every message.
The default is unset unless <tt>file</tt> is specified and <tt>use&#095;bsmtp</tt> is not set, in
which case it is a single newline character. The suffix can be suppressed by
setting
<pre>
&nbsp;&nbsp;message_suffix =
</pre>
<hr></p>
<a name="IX1990"></a>
<h3>mode</h3>
<i>Type:</i>&nbsp; octal integer<br><i>Default:</i>&nbsp; 0600<br>
<p>
If the output file is created, it is given this mode. If it already exists and
has wider permissions, they are reduced to this mode. If it has narrower
permissions, an error occurs unless <tt>mode_fail_narrower</tt> is false. However,
if the delivery is the result of a <tt>save</tt> command in a filter file specifing a
particular mode, the mode of the output file is always forced to take that
value, and this option is ignored.
<hr></p>
<a name="IX1991"></a>
<h3>mode_fail_narrower</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; true<br>
<p>
This option applies in the case when an existing mailbox file has a narrower
mode than that specified by the <tt>mode</tt> option. If <tt>mode&#095;fail&#095;narrower</tt> is
true, the delivery is deferred (&#147;mailbox has the wrong mode&#148;); otherwise Exim
continues with the delivery attempt, using the existing mode of the file.
<hr></p>
<a name="IX1992"></a>
<h3>notify_comsat</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
If this option is true, the <i>comsat</i> daemon is notified after every successful
delivery to a user mailbox. This is the daemon that notifies logged on users
about incoming mail.
<hr></p>
<a name="IX1993"></a>
<a name="IX1994"></a>
<h3>quota</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option imposes a limit on the size of the file to which Exim is appending,
or to the total space used in the directory tree when the <tt>directory</tt> option is
set. In the latter case, computation of the space used is expensive, because
all the files in the directory (and any sub-directories) have to be
individually inspected and their sizes summed. 
<font color=green>
(See <tt>quota&#095;size&#095;regex</tt> and <tt>maildir&#095;use&#095;size&#095;file</tt> for ways to avoid this
in environments where users have no shell access to their mailboxes).
</p>
<p>
As there is no interlock against two simultaneous deliveries into a
multi-file mailbox, it is possible for the quota to be overrun in this case.
For single-file mailboxes, of course, an interlock is a necessity.
</font>
</p>
<p>
A file's size is taken as its <i>used</i> value. Because of blocking effects, this
may be a lot less than the actual amount of disk space allocated to the file.
If the sizes of a number of files are being added up, the rounding effect can
become quite noticeable, especially on systems that have large block sizes.
Nevertheless, it seems best to stick to the <i>used</i> figure, because this is
the obvious value which users understand most easily.
</p>
<p>
The value of the option is expanded, and must then be a numerical value
(decimal point allowed), optionally followed by one of the letters K or M. The
expansion happens while Exim is running as root, before it changes uid for the
delivery. This means that files which are inaccessible to the end user can be
used to hold quota values that are looked up in the expansion. When delivery
fails because this quota is exceeded, the handling of the error is as for
system quota failures.
</p>
<p>
<font color=green>
<b>Note</b>: A value of zero is interpreted as &#147;no quota&#148;. 
</font>
</p>
<p>
By default, Exim's quota checking mimics system quotas, and restricts the
mailbox to the specified maximum size, though the value is not accurate to the
last byte, owing to separator lines and additional headers that may get added
during message delivery. When a mailbox is nearly full, large messages may get
refused even though small ones are accepted, because the size of the current
message is added to the quota when the check is made. This behaviour can be
changed by setting <tt>quota&#095;is&#095;inclusive</tt> false. When this is done, the check
for exceeding the quota does not include the current message. Thus, deliveries
continue until the quota has been exceeded; thereafter, no further messages are
delivered. See also <tt>quota&#095;warn&#095;threshold</tt>.
<hr></p>
<a name="IX1995"></a>
<h3>quota_directory</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; unset<br>
<p>
This option defines the directory to check for quota purposes when delivering
into individual files. The default is the delivery directory, or, if a file
called <i>maildirfolder</i> exists in a maildir directory, the parent of the
delivery directory.
<hr></p>
<a name="IX1996"></a>
<h3>quota_filecount</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; 0<br>
<p>
This option applies when the <tt>directory</tt> option is set. It limits the total
number of files in the directory (compare the inode limit in system quotas). It
can only be used if <tt>quota</tt> is also set. The value is expanded; an expansion
failure causes delivery to be deferred.
<hr></p>
<a name="IX1997"></a>
<h3>quota_is_inclusive</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; true<br>
<p>
See <tt>quota</tt> above.
<hr></p>
<a name="IX1998"></a>
<h3>quota_size_regex</h3>
<i>Type:</i>&nbsp; string<br><i>Default:</i>&nbsp; unset<br>
<p>
This option applies when one of the delivery modes that writes a separate file
for each message is being used. When Exim wants to find the size of one of
these files in order to test the quota, it first checks <tt>quota&#095;size&#095;regex</tt>.
If this is set to a regular expression that matches the file name, and it
captures one string, that string is interpreted as a representation of the
file's size. The value of <tt>quota&#095;size&#095;regex</tt> is not expanded.
</p>
<p>
This feature is useful only when users have no shell access to their mailboxes
&#150; otherwise they could defeat the quota simply by renaming the files. This
facility can be used with maildir deliveries, by setting <tt>maildir&#095;tag</tt> to add
the file length to the file name. For example:
<pre>
&nbsp;&nbsp;maildir_tag = ,S=$message_size
&nbsp;&nbsp;quota_size_regex = ,S=(\d+)
</pre>
</p>
<p>
The regular expression should not assume that the length is at the end of the 
file name (even though <tt>maildir&#095;tag</tt> puts it there) because maildir MUAs 
sometimes add other information onto the ends of message file names.
<hr></p>
<a name="IX1999"></a>
<h3>quota_warn_message</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; see below<br>
<p>
See below for the use of this option. If it is not set when
<tt>quota&#095;warn&#095;threshold</tt> is set, it defaults to
<pre>
&nbsp;&nbsp;quota_warn_message = "\
&nbsp;&nbsp;  To: $local_part@$domain\n\
&nbsp;&nbsp;  Subject: Your mailbox\n\n\
&nbsp;&nbsp;  This message is automatically created \
&nbsp;&nbsp;  by mail delivery software.\n\n\
&nbsp;&nbsp;  The size of your mailbox has exceeded \
&nbsp;&nbsp;  a warning threshold that is\n\
&nbsp;&nbsp;  set by the system administrator.\n"
</pre>
<hr></p>
<a name="IX2000"></a>
<a name="IX2001"></a>
<a name="IX2002"></a>
<a name="IX2003"></a>
<h3>quota_warn_threshold</h3>
<i>Type:</i>&nbsp; string, expanded<br><i>Default:</i>&nbsp; 0<br>
<p>
This option is expanded in the same way as <tt>quota</tt> (see above). If the
resulting value is greater than zero, and delivery of the message causes the
size of the file or total space in the directory tree to cross the given
threshold, a warning message is sent. If <tt>quota</tt> is also set, the threshold may
be specified as a percentage of it by following the value with a percent sign.
For example:
<pre>
&nbsp;&nbsp;quota = 10M
&nbsp;&nbsp;quota_warn_threshold = 75%
</pre>
</p>
<p>
If <tt>quota</tt> is not set, a setting of <tt>quota&#095;warn&#095;threshold</tt> that ends with a
percent sign is ignored.
</p>
<p>
The warning message itself is specified by the <tt>quota&#095;warn&#095;message</tt> option,
and it must start with a <i>To:</i> header line containing the recipient(s). A
<i>Subject:</i> line should also normally be supplied. The <tt>quota</tt> option does not
have to be set in order to use this option; they are independent of one
another except when the threshold is specified as a percentage.
<hr></p>
<a name="IX2004"></a>
<a name="IX2005"></a>
<h3>use_bsmtp</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
If this option is set true, <b>appendfile</b> writes messages in &#147;batch SMTP&#148;
format, with the envelope sender and recipient(s) included as SMTP commands. If
you want to include a leading <font size=-1>HELO</font> command with such messages, you can do
so by setting the <tt>message&#095;prefix</tt> option. See section <a href="spec_43.html#SECT43.11">43.11</a> for
details of batch SMTP.
<hr></p>
<a name="IX2006"></a>
<a name="IX2007"></a>
<a name="IX2008"></a>
<h3>use_crlf</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
This option causes lines to be terminated with the two-character CRLF sequence
(carriage return, linefeed) instead of just a linefeed character. In the case
of batched SMTP, the byte sequence written to the file is then an exact image
of what would be sent down a real SMTP connection.
</p>
<p>
The contents of the <tt>message&#095;prefix</tt> and <tt>message&#095;suffix</tt> options are written
verbatim, so must contain their own carriage return characters if these are
needed. In cases where these options have non-empty defaults, the values end
with a single linefeed, so they 
must
be changed to end with <tt>&#092;r&#092;n</tt> if <tt>use&#095;crlf</tt> is set.
<hr></p>
<a name="IX2009"></a>
<h3>use_fcntl_lock</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; see below<br>
<p>
This option controls the use of the <i>fcntl()</i> function to lock a file for
exclusive use when a message is being appended. It is set by default unless
<tt>use&#095;flock&#095;lock</tt> is set. Otherwise, it should be turned off only if you know
that all your MUAs use lock file locking. When both <tt>use&#095;fcntl&#095;lock</tt> and
<tt>use&#095;flock&#095;lock</tt> are unset, <tt>use&#095;lockfile</tt> must be set.
<hr></p>
<a name="IX2010"></a>
<h3>use_flock_lock</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; false<br>
<p>
This option is provided to support the use of <i>flock()</i> for file locking, for
the few situations where it is needed. Most modern operating systems support
<i>fcntl()</i> and <i>lockf()</i> locking, and these two functions interwork with
each other. Exim uses <i>fcntl()</i> locking by default.
</p>
<p>
This option is required only if you are using an operating system where
<i>flock()</i> is used by programs that access mailboxes (typically MUAs), and
where <i>flock()</i> does not correctly interwork with <i>fcntl()</i>. You can use
both <i>fcntl()</i> and <i>flock()</i> locking simultaneously if you want.
<a name="IX2011"></a>
</p>
<p>
Not all operating systems provide <i>flock()</i>. Some versions of Solaris do not
have it (and some, I think, provide a not quite right version built on top of
<i>lockf()</i>). If the OS does not have <i>flock()</i>, Exim will be built without
the ability to use it, and any attempt to do so will cause a configuration
error.
</p>
<p>
<b>Warning</b>: <i>flock()</i> locks do not work on NFS files (unless <i>flock()</i>
is just being mapped onto <i>fcntl()</i> by the OS).
<hr></p>
<a name="IX2012"></a>
<h3>use_lockfile</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; see below<br>
<p>
If this option is turned off, Exim does not attempt to create a lock file when
appending to a mailbox file. In this situation, the only locking is by
<i>fcntl()</i>. You should only turn <tt>use&#095;lockfile</tt> off if you are absolutely
sure that every MUA that is ever going to look at your users' mailboxes uses
<i>fcntl()</i> rather than a lock file, and even then only when you are not
delivering over NFS from more than one host.
<a name="IX2013"></a>
</p>
<p>
In order to append to an NFS file safely from more than one host, it is
necessary to take out a lock <em>before</em> opening the file, and the lock file
achieves this. Otherwise, even with <i>fcntl()</i> locking, there is a risk of
file corruption.
</p>
<p>
The <tt>use&#095;lockfile</tt> option is set by default unless <tt>use&#095;mbx&#095;lock</tt> is set. It
is not possible to turn both <tt>use&#095;lockfile</tt> and <tt>use&#095;fcntl&#095;lock</tt> off, except
when <tt>mbx&#095;format</tt> is set.
<hr></p>
<a name="IX2014"></a>
<h3>use_mbx_lock</h3>
<i>Type:</i>&nbsp; boolean<br><i>Default:</i>&nbsp; see below<br>
<p>
This option is available only if Exim has been compiled with <font size=-1>SUPPORT&#095;MBX</font>
set in <i>Local/Makefile</i>. Setting the option specifies that special MBX
locking rules be used. It is set by default if <tt>mbx&#095;format</tt> is set and none of
the locking options are mentioned in the configuration. The locking rules are
the same as are used by the <i>c-client</i> library that underlies Pine and the
IMAP4 and POP daemons that come with it (see the discussion below). The rules
allow for shared access to the mailbox. However, this kind of locking does not
work when the mailbox is NFS mounted.
</p>
<p>
You can set <tt>use&#095;mbx&#095;lock</tt> with either (or both) of <tt>use&#095;fcntl&#095;lock</tt> and
<tt>use&#095;flock&#095;lock</tt> to control what kind of locking is used in implementing the
MBX locking rules. The default is to use <i>fcntl()</i> if <tt>use&#095;mbx&#095;lock</tt> is set
without <tt>use&#095;fcntl&#095;lock</tt> or <tt>use&#095;flock&#095;lock</tt>.
<hr><br>
</p>
<a name="IX2015"></a>
<a name="IX2016"></a>
<h2>
<a name="SECT26.3" href="spec_toc.html#TOC200">
26.3. Operational details for appending
</a></h2>
<p>
Before appending to a file, the following preparations are made:
</p>
<ul>
<li><p>
If the name of the file is <i>/dev/null</i>, no action is taken, and a success
return is given.
</p>
</li>
<li><a name="IX2017"></a>
<p>
If any directories on the file's path are missing, Exim creates them if the
<tt>create&#095;directory</tt> option is set. A created directory's mode is given by the
<tt>directory&#095;mode</tt> option.
</p>
</li>
<li><p>
If <tt>file&#095;format</tt> is set, the format of an existing file is checked. If this
indicates that a different transport should be used, control is passed to that
transport.
</p>
</li>
<li><a name="IX2018"></a>
<a name="IX2019"></a>
<a name="IX2020"></a>
<p>
If <tt>use&#095;lockfile</tt> is set, a lock file is built in a way that will work
reliably over NFS, as follows:
</p>
<ul>
<li><p>
Create a &#147;hitching post&#148; file whose name is that of the lock file with the
current time, primary host name, and process id added, by opening for writing
as a new file. If this fails with an access error, delivery is deferred.
</p>
</li>
<li><p>
Close the hitching post file, and hard link it to the lock file name.
</p>
</li>
<li><p>
If the call to <i>link()</i> succeeds, creation of the lock file has succeeded.
Unlink the hitching post name.
</p>
</li>
<li><p>
Otherwise, use <i>stat()</i> to get information about the hitching post file, and
then unlink hitching post name. If the number of links is exactly two, creation
of the lock file succeeded but something (for example, an NFS server crash and
restart) caused this fact not to be communicated to the <i>link()</i> call.
</p>
</li>
<li><p>
If creation of the lock file failed, wait for <tt>lock&#095;interval</tt> and try again,
up to <tt>lock&#095;retries</tt> times. However, since any program that writes to a
mailbox should complete its task very quickly, it is reasonable to time out old
lock files that are normally the result of user agent and system crashes. If an
existing lock file is older than <tt>lockfile&#095;timeout</tt> Exim attempts to unlink it
before trying again.
</p>
</li>
</ul>
</li>
<li><p>
A call is made to <i>lstat()</i> to discover whether the main file exists, and if
so, what its characteristics are. If <i>lstat()</i> fails for any reason other
than non-existence, delivery is deferred.
</p>
</li>
<li><a name="IX2021"></a>
<a name="IX2022"></a>
<p>
If the file does exist and is a symbolic link, delivery is deferred, unless the
<tt>allow&#095;symlink</tt> option is set, in which case the ownership of the link is
checked, and then <i>stat()</i> is called to find out about the real file, which
is then subjected to the checks below. The check on the top-level link
ownership prevents one user creating a link for another's mailbox in a sticky
directory, though allowing symbolic links in this case is definitely not a good
idea. If there is a chain of symbolic links, the intermediate ones are not
checked.
</p>
</li>
<li><p>
If the file already exists but is not a regular file, or if the file's owner
and group (if the group is being checked &#150; see <tt>check&#095;group</tt> above) are
different from the user and group under which the delivery is running,
delivery is deferred.
</p>
</li>
<li><p>
If the file's permissions are more generous than specified, they are reduced.
If they are insufficient, delivery is deferred, unless <tt>mode&#095;fail&#095;narrower</tt>
is set false, in which case the delivery is tried using the existing
permissions.
</p>
</li>
<li><p>
The file's inode number is saved, and the file is then opened for appending. If
this fails because the file has vanished, <b>appendfile</b> behaves as if it hadn't
existed (see below). For any other failures, delivery is deferred.
</p>
</li>
<li><p>
If the file is opened successfully, check that the inode number hasn't
changed, that it is still a regular file, and that the owner and permissions
have not changed. If anything is wrong, defer delivery and freeze the message.
</p>
</li>
<li><p>
If the file did not exist originally, defer delivery if the <tt>file&#095;must&#095;exist</tt>
option is set. Otherwise, check that the file is being created in a permitted
directory if the <tt>create&#095;file</tt> option is set (deferring on failure), and then
open for writing as a new file, with the <font size=-1>O&#095;EXCL</font> and <font size=-1>O&#095;CREAT</font> options,
except when dealing with a symbolic link (the <tt>allow&#095;symlink</tt> option must be
set). In this case, which can happen if the link points to a non-existent file,
the file is opened for writing using <font size=-1>O&#095;CREAT</font> but not <font size=-1>O&#095;EXCL</font>, because
that prevents link following.
</p>
</li>
<li><a name="IX2023"></a>
<p>
If opening fails because the file exists, obey the tests given above for
existing files. However, to avoid looping in a situation where the file is
being continuously created and destroyed, the exists/not-exists loop is broken
after 10 repetitions, and the message is then frozen.
</p>
</li>
<li><p>
If opening fails with any other error, defer delivery.
</p>
</li>
<li><a name="IX2024"></a>
<a name="IX2025"></a>
<p>
Once the file is open, unless both <tt>use&#095;fcntl&#095;lock</tt> and <tt>use&#095;flock&#095;lock</tt>
are false, it is locked using <i>fcntl()</i> or <i>flock()</i> or both. If
<tt>use&#095;mbx&#095;lock</tt> is false, an exclusive lock is requested in each case. 
However, if <tt>use&#095;mbx&#095;lock</tt> is true,
Exim takes out a shared lock on the open file,
and an exclusive lock on the file whose name is
</p>
<p>
<tt>&nbsp;&nbsp;</tt><tt>/tmp/.&#060;<em>device-number</em>&#062;.&#060;<em>inode-number</em>&#062;</tt><br>
</p>
<p>
using the device and inode numbers of the open mailbox file, in accordance with
the MBX locking rules.
</p>
<p>
If Exim fails to lock the file, there are two possible courses of action,
depending on the value of the locking timeout. This is obtained from
<tt>lock&#095;fcntl&#095;timeout</tt> or <tt>lock&#095;flock&#095;timeout</tt>, as appropriate.
</p>
<p>
If the timeout value is zero, the file is closed, Exim waits for
<tt>lock&#095;interval</tt>, and then goes back and re-opens the file as above and tries
to lock it again. This happens up to <tt>lock&#095;retries</tt> times, after which the
delivery is deferred.
</p>
<p>
If the timeout has a value greater than zero, blocking calls to <i>fcntl()</i> or
<i>flock()</i> are used (with the given timeout), so there has already been some
waiting involved by the time locking fails. Nevertheless, Exim does not give up
immediately. It retries up to
</p>
<p>
<tt>&nbsp;&nbsp;</tt><tt>(lock&#095;retries * lock&#095;interval) / &#060;<em>timeout</em>&#062;</tt><br>
</p>
<p>
times (rounded up).
</p>
</li>
</ul>
<p>
At the end of delivery, Exim closes the file (which releases the <i>fcntl()</i>
and/or <i>flock()</i> locks) and then deletes the lock file if one was created.
</p>
<a name="IX2026"></a>
<a name="IX2027"></a>
<h2>
<a name="SECT26.4" href="spec_toc.html#TOC201">
26.4. Operational details for delivery to a new file
</a></h2>
<p>
When the <tt>directory</tt> option is set instead of <tt>file</tt>, each message is delivered
into a newly-created file or set of files. When <b>appendfile</b> is activated 
directly from a <b>redirect</b> router, neither <tt>file</tt> nor <tt>directory</tt> is normally 
set, because the path for delivery is supplied by the router. (See for example, 
the <b>address&#095;file</b> transport in the default configuration.) In this case, 
delivery is to a new file if either the path name ends in <tt>/</tt>, or the 
<tt>maildir&#095;format</tt> or <tt>mailstore&#095;format</tt> option is set.
</p>
<p>
No locking is required while writing the message to a new file, so the various
locking options of the transport are ignored. The &#147;From&#148; line that by default
separates messages in a single file is not normally needed, nor is the escaping
of message lines that start with &#147;From&#148;, and there is no need to ensure a
newline at the end of each message. Consequently, the default values for
<tt>check&#095;string</tt>, <tt>message&#095;prefix</tt>, and <tt>message&#095;suffix</tt> are all unset when
any of <tt>directory</tt>, <tt>maildir&#095;format</tt>, or <tt>mailstore&#095;format</tt> is set.
</p>
<p>
If Exim is required to check a <tt>quota</tt> setting, it adds up the sizes of all the 
files in the delivery directory by default. However, you can specify a 
different directory by setting <tt>quota&#095;directory</tt>. Also, for maildir deliveries 
(see below) the <i>maildirfolder</i> convention is honoured.
<a name="IX2028"></a>
<a name="IX2029"></a>
</p>
<p>
There are three different ways in which delivery to individual files can be
done, controlled by the settings of the <tt>maildir&#095;format</tt> and
<tt>mailstore&#095;format</tt> options. Note that code to support maildir or mailstore
formats is not included in the binary unless <font size=-1>SUPPORT&#095;MAILDIR</font> or
<font size=-1>SUPPORT&#095;MAILSTORE</font>, respectively, is set in <i>Local/Makefile</i>.
<a name="IX2030"></a>
</p>
<p>
In all three cases an attempt is made to create the directory and any necessary
sub-directories if they do not exist, provided that the <tt>create&#095;directory</tt>
option is set (the default). The location of a created directory can be
constrained by setting <tt>create&#095;file</tt>. A created directory's mode is given by
the <tt>directory&#095;mode</tt> option. If creation fails, or if the <tt>create&#095;directory</tt>
option is not set when creation is required, delivery is deferred.
</p>
<a name="IX2031"></a>
<h2>
<a name="SECT26.5" href="spec_toc.html#TOC202">
26.5. Maildir delivery
</a></h2>
<p>
If the <tt>maildir&#095;format</tt> option is true, Exim delivers each message by writing
it to a file whose name is <i>tmp/&#060;<em>stime</em>&#062;.H&#060;<em>mtime</em>&#062;P&#060;<em>pid</em>&#062;.&#060;<em>host</em>&#062;</i> in the
given directory. If the delivery is successful, the file is renamed into the 
<i>new</i> subdirectory.
</p>
<p>
In the file name, &#060;<em>stime</em>&#062; is the current time of day in seconds, and
&#060;<em>mtime</em>&#062; is the microsecond fraction of the time. After a maildir delivery,
Exim checks that the time-of-day clock has moved on by at least one microsecond
before terminating the delivery process. This guarantees uniqueness for the
file name. However, as a precaution, Exim calls <i>stat()</i> for the file before
opening it. If any response other than <font size=-1>ENOENT</font> (does not exist) is given,
Exim waits 2 seconds and tries again, up to <tt>maildir&#095;retries</tt> times.
<a name="IX2032"></a>
<a name="IX2033"></a>
</p>
<p>
If Exim is required to check a <tt>quota</tt> setting before a maildir delivery, and
<tt>quota&#095;directory</tt> is not set, it looks for a file called <i>maildirfolder</i> in
the maildir directory (alongside <i>new</i>, <i>cur</i>, <i>tmp</i>). If this exists,
Exim assumes the directory is a maildir++ folder directory, which is one level
down from the user's top level mailbox directory. This causes it to start at
the parent directory instead of the current directory when calculating the
amount of space used.
</p>
<h2>
<a name="SECT26.6" href="spec_toc.html#TOC203">
26.6. Using tags to record message sizes
</a></h2>
<p>
If <tt>maildir&#095;tag</tt> is set, the string is expanded for each delivery. 
When the maildir file is renamed into the <i>new</i> sub-directory, the
tag is added to its name. However, if adding the tag takes the length of the
name to the point where the test <i>stat()</i> call fails with <font size=-1>ENAMETOOLONG</font>,
the tag is dropped and the maildir file is created with no tag. 
</p>
<p>
Tags can be used to encode the size of files in their names; see
<tt>quota&#095;size&#095;regex</tt> above for an example. The expansion of <tt>maildir&#095;tag</tt> 
happens after the message has been written. The value of the <tt>$message&#095;size</tt>
variable is set to the number of bytes actually written. If the expansion is
forced to fail, the tag is ignored, but a non-forced failure causes delivery to
be deferred. The expanded tag may contain any printing characters except &#147;/&#148;.
Non-printing characters in the string are ignored; if the resulting string is
empty, it is ignored. If it starts with an alphanumeric character, a leading
colon is inserted.
<font color=green></p>
<a name="IX2034"></a>
<a name="IX2035"></a>
<h2>
<a name="SECT26.7" href="spec_toc.html#TOC204">
26.7. Using a maildirsize file
</a></h2>
<p>
If <tt>maildir&#095;use&#095;size&#095;file</tt> is true, Exim implements the maildir++ rules for
storing quota and message size information in a file called <i>maildirsize</i>
within the maildir directory. If this file does not exist, Exim creates it,
setting the quota from the <tt>quota</tt> option of the transport. If the maildir
directory itself does not exist, it is created before any attempt to write a
<i>maildirsize</i> file.
</p>
<p>
The <i>maildirsize</i> file is used to hold information about the sizes of
messages in the maildir, thus speeding up quota calculations. The quota value
in the file is just a cache; if the quota is changed in the transport, the new
value overrides the cached value when the next message is delivered. The cache
is maintained for the benefit of other programs that access the maildir and
need to know the quota.
</p>
<p>
If the <tt>quota</tt> option in the transport is unset or zero, the <i>maildirsize</i>
file is maintained (with a zero quota setting), but no quota is imposed.
</p>
<p>
A regular expression is available for controlling which directories in the
maildir participate in quota calculations. See the description of the 
<tt>maildir&#095;quota&#095;directory&#095;regex</tt> option above for details.
</font>
</p>
<a name="IX2036"></a>
<h2>
<a name="SECT26.8" href="spec_toc.html#TOC205">
26.8. Mailstore delivery
</a></h2>
<p>
If the <tt>mailstore&#095;format</tt> option is true, each message is written as two files
in the given directory. A unique base name is constructed from the message id
and the current delivery process, and the files that are written use this base
name plus the suffixes <i>.env</i> and <i>.msg</i>. The <i>.env</i> file contains the
message's envelope, and the <i>.msg</i> file contains the message itself.
</p>
<p>
During delivery, the envelope is first written to a file with the suffix
<i>.tmp</i>. The <i>.msg</i> file is then written, and when it is complete, the
<i>.tmp</i> file is renamed as the <i>.env</i> file. Programs that access messages in
mailstore format should wait for the presence of both a <i>.msg</i> and a <i>.env</i>
file before accessing either of them. An alternative approach is to wait for
the absence of a <i>.tmp</i> file.
</p>
<p>
The envelope file starts with any text defined by the <tt>mailstore&#095;prefix</tt>
option, expanded and terminated by a newline if there isn't one. Then follows
the sender address on one line, then all the recipient addresses, one per line.
There can be more than one recipient only if the <tt>batch&#095;max</tt> option is set
greater than one. Finally, <tt>mailstore&#095;suffix</tt> is expanded and the result
appended to the file, followed by a newline if it does not end with one.
</p>
<p>
If expansion of <tt>mailstore&#095;prefix</tt> or <tt>mailstore&#095;suffix</tt> ends with a forced
failure, it is ignored. Other expansion errors are treated as serious
configuration errors, and delivery is deferred.
</p>
<h2>
<a name="SECT26.9" href="spec_toc.html#TOC206">
26.9. Non-special new file delivery
</a></h2>
<p>
If neither <tt>maildir&#095;format</tt> nor <tt>mailstore&#095;format</tt> is set, a single new file
is created directly in the named directory. For example, when delivering
messages into files in batched SMTP format for later delivery to some host (see
section <a href="spec_43.html#SECT43.11">43.11</a>), a setting such as
<pre>
&nbsp;&nbsp;directory = /var/bsmtp/$host
</pre>
</p>
<p>
might be used. A message is written to a file with a temporary name, which is
then renamed when the delivery is complete. The final name is obtained by
expanding the contents of the <tt>directory&#095;file</tt> option.
<hr>
</p>
<font size=2>
<a href="spec_25.html">Previous</a>&nbsp;&nbsp;<a href="spec_27.html">Next</a>&nbsp;&nbsp;<a href="spec_toc.html">Contents</a>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Exim 4.40 Specification)
</font>
</body>
</html>
